---
const isHome = Astro.url.pathname === "/";
const homeAnchor = (hash: string) => (isHome ? hash : `/${hash}`);
---

<header class:list={["site-header", { "scroll-reveal": isHome }]} role="banner">
  <div class="container header-inner">
    <a class="brand" href={isHome ? "#top" : "/"}>
      <!-- <div class="avatar" aria-hidden="true">
        <img src="/picture.jpg" alt="Profile picture of Maxim Gannota" />
      </div> -->
      <div class="brand-text">
        <span class="brand-name">Maxim Gannota</span>
        <span class="brand-subtitle">Student Â· Developer in progress</span>
      </div>
    </a>

    <nav class="main-nav" aria-label="Primary">
      <div id="nav-marker"></div>
      <a href={homeAnchor("#about")}>About</a>
      <a href={homeAnchor("#projects")}>Projects</a>
      <a href={homeAnchor("#now")}>Now</a>
      <a href={homeAnchor("#socials")}>Socials</a>
      <a href="/blog">Blog</a>
    </nav>

    <div class="header-actions">
      <button id="theme-toggle" aria-label="Toggle theme">
        <!-- Sun (light) -->
        <svg
          class="icon sun"
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><circle cx="12" cy="12" r="5"></circle><line
            x1="12"
            y1="1"
            x2="12"
            y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line
            x1="4.22"
            y1="4.22"
            x2="5.64"
            y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"
          ></line><line x1="1" y1="12" x2="3" y2="12"></line><line
            x1="21"
            y1="12"
            x2="23"
            y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"
          ></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg
        >
        <!-- Moon (dark) -->
        <svg
          class="icon moon"
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
          ></path></svg
        >
      </button>

      <!-- Header Clock -->
      <div
        id="header-clock"
        class="header-clock"
        aria-label="Current time (GMT+2)"
      >
        <span class="clock-hm">--:--</span><span class="clock-s"></span>
      </div>
    </div>
  </div>
</header>

<script>
  const initHeader = () => {
    // Clock Logic
    const clockContainer = document.getElementById("header-clock");
    const hmElement = clockContainer?.querySelector(".clock-hm");
    const sElement = clockContainer?.querySelector(".clock-s");

    if (clockContainer && hmElement && sElement) {
      const updateClock = () => {
        // GMT+2 Fixed Calculation
        const now = new Date();
        const utc = now.getTime() + now.getTimezoneOffset() * 60000;
        const targetTime = new Date(utc + 3600000 * 2);

        const h = targetTime.getHours().toString().padStart(2, "0");
        const m = targetTime.getMinutes().toString().padStart(2, "0");
        const s = targetTime.getSeconds().toString().padStart(2, "0");

        hmElement.textContent = `${h}:${m}`;
        sElement.textContent = `:${s}`;
      };

      updateClock();
      setInterval(updateClock, 1000);
    }

    // Theme Toggle Logic
    const handleToggleClick = () => {
      const element = document.documentElement;
      const isLight = element.getAttribute("data-theme") === "light";
      const newTheme = isLight ? "dark" : "light";

      element.setAttribute("data-theme", newTheme);
      localStorage.setItem("theme", newTheme);
    };

    const toggleBtn = document.getElementById("theme-toggle");
    // Remove old listener to avoid duplicates if re-running (though atomic replacements help)
    toggleBtn?.removeEventListener("click", handleToggleClick);
    toggleBtn?.addEventListener("click", handleToggleClick);

    // Scroll Reveal for Header & Site
    const handleScroll = () => {
      if (window.scrollY > 50) {
        document.body.classList.add("scrolled-mode");
      } else {
        document.body.classList.remove("scrolled-mode");
      }
    };

    window.removeEventListener("scroll", handleScroll);
    window.addEventListener("scroll", handleScroll);
    handleScroll(); // Check initial state

    // Sliding Nav Marker Logic
    // Variables already declared above in initHeader scope, ensuring no redeclaration.
    const navContainer = document.querySelector(".main-nav") as HTMLElement;
    const navMarker = document.getElementById("nav-marker");
    const navLinks = document.querySelectorAll(".main-nav a");

    if (navContainer && navMarker) {
      navLinks.forEach((link) => {
        link.addEventListener("mouseenter", (e) => {
          const target = e.target as HTMLElement;
          navMarker.style.width = `${target.offsetWidth}px`;
          navMarker.style.left = `${target.offsetLeft}px`;
          navMarker.style.opacity = "1";
        });

        // Intercept anchor clicks when not on home
        const href = link.getAttribute("href");
        if (href && href.startsWith("/#")) {
          link.addEventListener("click", (e) => {
            // Only if we aren't already on home
            if (window.location.pathname !== "/") {
              e.preventDefault();
              const targetId = href.substring(2); // remove '/#'
              sessionStorage.setItem("scrollTarget", targetId);
              window.location.href = "/";
            }
          });
        }
      });

      navContainer.addEventListener("mouseleave", () => {
        navMarker.style.opacity = "0";
      });
    }

    // Check for pending scroll target from navigation
    const pendingScroll = sessionStorage.getItem("scrollTarget");
    if (pendingScroll && window.location.pathname === "/") {
      // Wait for page load / transition
      const target = document.getElementById(pendingScroll);
      if (target) {
        // Slight delay to allow transition to settle
        setTimeout(() => {
          target.scrollIntoView({ behavior: "smooth" });
          sessionStorage.removeItem("scrollTarget");
        }, 300);
      }
    }
  };

  // Run on initial load and after every navigation
  document.addEventListener("astro:page-load", initHeader);
</script>

<style>
  /* Header Clock Styles */
  .header-clock {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-muted);
    font-feature-settings: "tnum";
    font-variant-numeric: tabular-nums;
    margin-left: 0.75rem;
    padding-left: 0.75rem;
    border-left: 1px solid var(--border-subtle);
    cursor: default;
    display: flex;
    align-items: center;
    overflow: hidden; /* For revealed seconds */
  }

  .clock-s {
    opacity: 0;
    max-width: 0;
    transform: translateX(-5px);
    transition:
      opacity 0.4s ease,
      max-width 0.4s cubic-bezier(0.2, 0.8, 0.2, 1),
      transform 0.4s ease;
    white-space: nowrap;
    display: inline-block;
  }

  .header-clock:hover .clock-s {
    opacity: 1;
    max-width: 2em; /* Enough for :SS */
    transform: translateX(0);
  }

  /* Header Scroll Animation - Only for Home */
  .site-header.scroll-reveal {
    opacity: 0;
    transform: translateY(-1rem);
    transition:
      opacity 0.4s ease,
      transform 0.4s ease;
    pointer-events: none; /* Prevent clicks when hidden */
  }

  /* When body has scrolled-mode, show header */
  :global(body.scrolled-mode) .site-header.scroll-reveal {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  /* Sliding Marker Styles */
  .main-nav {
    position: relative; /* Context */
  }

  #nav-marker {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    height: 100%; /* Or fixed height e.g. 80% */
    background: var(--accent-soft);
    border-radius: var(--radius-full);
    z-index: -1; /* Behind text */
    transition:
      left 0.3s cubic-bezier(0.25, 1, 0.5, 1),
      width 0.3s cubic-bezier(0.25, 1, 0.5, 1),
      opacity 0.2s ease;
    opacity: 0;
    pointer-events: none;
  }

  /* By default, hide both icons to prevent overlap */
  #theme-toggle .icon {
    display: none;
  }

  /* Light theme: Show Moon */
  :global(html[data-theme="light"]) #theme-toggle .moon {
    display: block;
  }

  /* Dark theme: Show Sun */
  :global(html[data-theme="dark"]) #theme-toggle .sun {
    display: block;
  }

  /* Fallback: If no theme set (SSR/No-JS), default to Dark (Sun) */
  :global(html:not([data-theme])) #theme-toggle .sun {
    display: block;
  }
</style>
